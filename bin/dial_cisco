#!/usr/bin/perl

# based on code from http://smallhacks.wordpress.com/2012/04/11/command-line-dialing-on-cisco-79407960-ip-phone-9/

# modules
use Net::Telnet;
use Time::HiRes;


my $host='10.0.0.1';	# cisco phone host name
my $password='cisco';	# cisco phone password
my $mute=0;		# mute on a dial 0/1

my $sleeptime=.2;
my $prompt='/> $/';

my $argc = scalar @ARGV;
if ($argc != 1) {
	print "Usage: call.pl <number>\n";
	exit;
}
my $number=@ARGV[0];

if($number!~/^[0-9*#]+$/) {
	print "Error: wrong characters in the numer\n";
	exit 2;
}
$telnet = new Net::Telnet ( Timeout=>3, Errmode=>'die');

# connecting
$telnet->open($host);
$telnet->waitfor('/Password :$/i'); 
$telnet->print($password); 
$telnet->waitfor($prompt);

$telnet->print('test open');
$telnet->waitfor($prompt);
$telnet->print('test key spkr');
$telnet->waitfor($prompt);Time::HiRes::sleep($sleeptime);
if( $mute ) {
	$telnet->print('test key mute');
	$telnet->waitfor($prompt);Time::HiRes::sleep($sleeptime);
}
$telnet->print("test key ".$number."#");
$telnet->waitfor($prompt);Time::HiRes::sleep((length($number)+1)*$sleeptime);
$telnet->print('test close');
$telnet->waitfor($prompt);
$telnet->close($host);
