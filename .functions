#!/bin/bash

#
# source /home/chicks/.functions
#
# to get these funcitons in your script.
#

# RH or Deb/Ub/Mint?
#
# set CHICKOS environment variable with RPM_CENTOS or DEB_MINT or broken_shit
#
function check_os {
	export CHICKOS=broken_shit

	if [[ -f /etc/redhat_release ]]
	then
		CHICKOS=RPM_CENTOS
	else
		if [[ -f /etc/debian_version ]]
		then
			CHICKOS=DEB_MINT
		else
			echo dunno, left CHICKOS=$CHICKOS
		fi
	fi
}

function check_packages {
	check_os # set CHICKOS

	echo "check_packages()..."

	UNIVERSAL_PKGS="vim screen mtr perl bash whois pcregrep curl wget"
	RPM_PKGS="vim-enhanced"
	DEB_PKGS=""
	NEED_PKGS=""

	# debian mint
	if [[ $CHICKOS == "DEB_MINT" ]]
	then
		for deb_pkg in $UNIVERSAL_PKGS $DEB_PKGS
		do
			if dpkg-query -W -f '${binary:Package}\n' | grep "^$deb_pkg\$" > /dev/null 
			then
				#echo -e "\t$deb_pkg IS installed"
				true
			else
				echo -e "\t$deb_pkg is not installed"
				NEED_PKGS="$NEED_PKGS $deb_pkg"
			fi
		done
		echo  -e "\t# sudo apt-get install $NEED_PKGS"
	fi

	# rpm centos
	if [[ $CHICKOS == "RPM_CENTOS" ]]
	then
		for rpm_pkg in $UNIVERSAL_PKGS $RPM_PKGS
		do
			if rpm -q --quiet $rpm_pkg 
			then
				#echo -e "\t$rpm_pkg IS installed"
				true
			else
				echo $rpm_pkg is not installed
				NEED_PKGS="$NEED_PKGS $rpm_pkg"
			fi
		done
		echo  -e "\t# sudo yum install -y $NEED_PKGS"
	fi

	echo "check done."
}

#
function check_all_permissions {
	echo checking ~/.ssh/\* permisisons...

	# should always exist
	check_file_permissions ~/.ssh 700
	check_file_permissions ~/.ssh/config 600

	# should be optional
	if [[ -e ~/.ssh/id_rsa ]]
	then
		check_file_permissions ~/.ssh/id_rsa 600
		check_file_permissions ~/.ssh/id_rsa.pub 644
	else
		echo -e "\tyour local ssh key is missing"
	fi
}

# arguments: filename permisison
function check_file_permissions {
	if [[ $# -lt 2 ]]
	then
		echo you need 2 arguments to 'check_permissions()', not $#
		exit 3
	fi

	if [[ $# -gt 2 ]]
	then
		echo you need 2 arguments, not $# to 'check_permisisons()'
		exit 3
	fi

	FILE=$1
	DESIRED=$2

	get_perm $FILE # set RETURN_PERM
	ACTUAL=$RETURN_PERM

	if [[ $ACTUAL != $DESIRED ]]
	then
		echo -e "\t$FILE has $ACTUAL permissions instead of desired $DESIRED"
	fi
}

# arguments: filename
# returns value in $RETURN_PERM
function get_perm {
	if [[ $# -lt 1 ]]
	then
		echo you need to pass filenames 'get_perm()'
		return 1
	fi

	FILE=$1

	# we want -e not -f so we can get permissions on non-files
	if [[ ! -e $FILE ]]
	then
		echo "get_perm($FILE): no such file"
		return 2
	fi

	RET=`stat -c %a $FILE`
#	echo got $RET for $FILE
	RETURN_PERM=$RET

	return 0
}

function is_interactive {
	RET=3

	if [[ -z $PS1 ]] # no prompt?
	### if [ -v PS1 ]   # On Bash 4.2+ ...
	then
		# non-interactive
		RET=0
	else
		# interactive
		RET=1
	fi

#	echo return $RET
	return $RET
}

echo processed all of .functions
